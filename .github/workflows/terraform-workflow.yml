name: terraform-workflow

on:
  push:
    branches: ["main"]
    paths:
      - "infrastructure/**"
      - ".github/workflows/terraform-workflow.yml"
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to deploy to"
        required: true
        default: "Development"
        type: choice
        options:
          - Development
          - Production

permissions:
  issues: write
  contents: read

jobs:
  plan:
    name: "Terraform Plan"
    runs-on: ubuntu-latest
    environment:
      name: ${{ inputs.environment || (github.ref == 'refs/heads/main' && 'Production' || 'Development') }}
    defaults:
      run:
        working-directory: ./infrastructure

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set Environment
        uses: ./.github/actions/set-env
        with:
          environment: ${{ inputs.environment }}

      - name: Setup OCI Credentials
        uses: ./.github/actions/assume-oci-role
        with:
          oci_private_key: ${{ secrets.OCI_PRIVATE_KEY }}
          oci_tenancy_ocid: ${{ secrets.OCI_TENANCY_OCID }}
          oci_user_ocid: ${{ secrets.OCI_USER_OCID }}
          oci_fingerprint: ${{ secrets.OCI_FINGERPRINT }}
          oci_region: ${{ secrets.OCI_REGION }}
          ssh_public_key: ${{ secrets.SSH_PUBLIC_KEY }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: latest

      - name: Check Terraform Formatting
        run: |
          terraform fmt -recursive -check

          if [ $? -ne 0 ]; then
            echo "Terraform files are not formatted correctly."
            exit 1
          else
            echo "Terraform files are correctly formatted."
          fi

      - name: Terraform Init
        run: terraform init

      - name: Terraform Validate
        run: terraform validate

      - name: Terraform Plan
        run: terraform plan -var-file="${{ env.TF_VAR_FILE }}"

  approve:
    name: "Wait for Approval"
    needs: plan
    runs-on: ubuntu-latest
    environment:
      name: ${{ inputs.environment || (github.ref == 'refs/heads/main' && 'Production' || 'Development') }}
    # Run if it's a push to main OR a manual dispatch
    if: (github.ref == 'refs/heads/main' && github.event_name == 'push') || github.event_name == 'workflow_dispatch'
    steps:
      - name: Manual Approval
        uses: trstringer/manual-approval@v1
        with:
          secret: ${{ secrets.GITHUB_TOKEN }}
          approvers: ${{ github.actor }}
          minimum-approvals: 1
          issue-title: "ðŸš€ Approval Required: Deploy to ${{ inputs.environment || (github.ref == 'refs/heads/main' && 'Production' || 'Development') }}"
          issue-body: |
            The Terraform Plan has completed successfully.

            Please review the plan in the [Actions logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}).

            Comment **approve** to proceed with the deployment.
            Comment **deny** to cancel.
          exclude-workflow-initiator-as-approver: false

  apply:
    name: "Terraform Apply"
    needs: approve
    runs-on: ubuntu-latest
    environment:
      name: ${{ inputs.environment || (github.ref == 'refs/heads/main' && 'Production' || 'Development') }}
    # Run if it's a push to main OR a manual dispatch
    if: (github.ref == 'refs/heads/main' && github.event_name == 'push') || github.event_name == 'workflow_dispatch'
    defaults:
      run:
        working-directory: ./infrastructure

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set Environment
        uses: ./.github/actions/set-env
        with:
          environment: ${{ inputs.environment }}

      - name: Setup OCI Credentials
        uses: ./.github/actions/assume-oci-role
        with:
          oci_private_key: ${{ secrets.OCI_PRIVATE_KEY }}
          oci_tenancy_ocid: ${{ secrets.OCI_TENANCY_OCID }}
          oci_user_ocid: ${{ secrets.OCI_USER_OCID }}
          oci_fingerprint: ${{ secrets.OCI_FINGERPRINT }}
          oci_region: ${{ secrets.OCI_REGION }}
          ssh_public_key: ${{ secrets.SSH_PUBLIC_KEY }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: latest

      - name: Terraform Init
        run: terraform init

      - name: Terraform Apply
        uses: ./.github/actions/terraform-apply
        with:
          working_directory: ./infrastructure
          var_file: environments/prod/prod.tfvars
