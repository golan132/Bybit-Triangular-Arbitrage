name: Build and Push Docker Image

on:
  push:
    branches: ["main"]
    paths:
      - "src/**"
      - "Cargo.toml"
      - "Cargo.lock"
      - "Dockerfile"
      - "precision_cache.json"
      - ".github/workflows/deploy-project.yml"
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'Development'
        type: choice
        options:
          - Development
          - Production

permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    environment:
      name: ${{ inputs.environment || (github.ref == 'refs/heads/main' && 'Production' || 'Development') }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Workspace
        uses: ./.github/actions/setup-workspace

      - name: Build and Push Docker Image
        uses: ./.github/actions/build-push-docker
        with:
          registry: ${{ env.REGISTRY }}
          image_name: ${{ env.IMAGE_NAME }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          platforms: linux/amd64

  deploy:
    name: Deploy to Server
    needs: build-and-push
    runs-on: ubuntu-latest
    environment:
      name: ${{ inputs.environment || (github.ref == 'refs/heads/main' && 'Production' || 'Development') }}
    if: (github.ref == 'refs/heads/main' && github.event_name == 'push') || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Debug Secrets
        run: |
          echo "Active Environment: ${{ inputs.environment || (github.ref == 'refs/heads/main' && 'Production' || 'Development') }}"
          if [ -z "${{ secrets.OCI_TENANCY_OCID }}" ]; then
            echo "::error::Secret OCI_TENANCY_OCID is missing! Ensure it is added to the correct Environment or Repository secrets."
          else
            echo "Secret OCI_TENANCY_OCID is found."
          fi

      - name: Setup OCI Credentials
        uses: ./.github/actions/assume-oci-role
        with:
          oci_private_key: ${{ secrets.OCI_PRIVATE_KEY }}
          oci_tenancy_ocid: ${{ secrets.OCI_TENANCY_OCID }}
          oci_user_ocid: ${{ secrets.OCI_USER_OCID }}
          oci_fingerprint: ${{ secrets.OCI_FINGERPRINT }}
          oci_region: ${{ secrets.OCI_REGION }}

      - name: Get Instance IP
        id: get-ip
        run: |
          if [ -z "$TF_VAR_tenancy_ocid" ]; then
            echo "Error: TF_VAR_tenancy_ocid is not set. Check your GitHub Secrets."
            exit 1
          fi

          # Find the instance by display name (must match what's in your Terraform)
          INSTANCE_ID=$(oci compute instance list --compartment-id $TF_VAR_tenancy_ocid --display-name "bybit-bot-instance" --query "data[0].id" --raw-output)

          if [ "$INSTANCE_ID" == "null" ] || [ -z "$INSTANCE_ID" ]; then
            echo "Instance not found!"
            exit 1
          fi

          # Get the Public IP from the VNIC
          VNIC_ID=$(oci compute vnic-attachment list --instance-id $INSTANCE_ID --compartment-id $TF_VAR_tenancy_ocid --query "data[0].\"vnic-id\"" --raw-output)
          PUBLIC_IP=$(oci network vnic get --vnic-id $VNIC_ID --query "data.\"public-ip\"" --raw-output)

          echo "Found Instance IP: $PUBLIC_IP"
          echo "instance_ip=$PUBLIC_IP" >> $GITHUB_OUTPUT

      - name: Lowercase Repo Name
        id: repo_name
        run: |
          echo "image_name=${GITHUB_REPOSITORY,,}" >> $GITHUB_OUTPUT

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ steps.get-ip.outputs.instance_ip }}
          username: opc
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # Login to GHCR
            echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin

            # Pull the new image
            docker pull ghcr.io/${{ steps.repo_name.outputs.image_name }}:latest

            # Stop and remove old container
            docker stop bot || true
            docker rm bot || true

            # Run new container
            docker run -d \
              --name bot \
              --restart on-failure \
              --network host \
              -e BYBIT_API_KEY=${{ secrets.BYBIT_API_KEY }} \
              -e BYBIT_API_SECRET=${{ secrets.BYBIT_API_SECRET }} \
              -e BYBIT_TESTNET=${{ vars.BYBIT_TESTNET || 'false' }} \
              -e DRY_RUN=${{ vars.DRY_RUN || 'true' }} \
              -e MAX_TRADES=${{ vars.MAX_TRADES || '10' }} \
              -e ORDER_SIZE=${{ vars.ORDER_SIZE || '10' }} \
              -e MIN_PROFIT_THRESHOLD=${{ vars.MIN_PROFIT_THRESHOLD || '0.01' }} \
              -e TRADING_FEE_RATE=${{ vars.TRADING_FEE_RATE || '0.00075' }} \
              -e MAX_TRIANGLES_TO_SCAN=${{ vars.MAX_TRIANGLES_TO_SCAN || '2000' }} \
              -e BALANCE_REFRESH_INTERVAL_SECS=${{ vars.BALANCE_REFRESH_INTERVAL_SECS || '60' }} \
              -e PRICE_REFRESH_INTERVAL_SECS=${{ vars.PRICE_REFRESH_INTERVAL_SECS || '2' }} \
              -e CYCLE_SUMMARY_INTERVAL=${{ vars.CYCLE_SUMMARY_INTERVAL || '100' }} \
              -e MIN_VOLUME_24H_USD=${{ vars.MIN_VOLUME_24H_USD || '2000.0' }} \
              -e MIN_BID_SIZE_USD=${{ vars.MIN_BID_SIZE_USD || '100.0' }} \
              -e MIN_ASK_SIZE_USD=${{ vars.MIN_ASK_SIZE_USD || '50.0' }} \
              -e MAX_SPREAD_PERCENT=${{ vars.MAX_SPREAD_PERCENT || '1.0' }} \
              -e MIN_TRADE_AMOUNT_USD=${{ vars.MIN_TRADE_AMOUNT_USD || '10.0' }} \
              -e RUST_LOG=${{ vars.RUST_LOG || 'info' }} \
              ghcr.io/${{ steps.repo_name.outputs.image_name }}:latest
